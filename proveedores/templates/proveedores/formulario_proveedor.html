{% extends 'base_public.html' %}
{% load static %}

{% block title %}
    {% if is_update %}
        Actualizar Proveedor - {{ proveedor.nombre_razon_social }}
    {% else %}
        Registro de Proveedor
    {% endif %}
{% endblock %}

{% block extra_css %}
<style>
    .signature-pad-container {
        border: 1px dashed #ccc;
        border-radius: 5px;
        padding: 10px;
        margin-top: 10px;
        position: relative;
    }
    .signature-pad-canvas {
        width: 100%;
        height: 200px;
        background-color: #f8f9fa;
    }
    .signature-pad-actions {
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
    <div class="form-header">
        <h1>
            <i class="fas fa-handshake"></i>
            {% if is_update %}
                Actualizar Mis Datos como Proveedor
            {% else %}
                Bienvenido - Formulario de Registro de Proveedores
            {% endif %}
        </h1>
        <p>
            {% if is_update %}
                Puede actualizar la información de su empresa cuando lo necesite
            {% else %}
                Queremos conocerlo mejor. Por favor complete la siguiente información (*campos obligatorios)
            {% endif %}
        </p>
    </div>

    <div class="form-container">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}

        <form method="post" enctype="multipart/form-data" id="proveedorForm">
            {% csrf_token %}

            <!-- SECCIÓN 1: INFORMACIÓN GENERAL -->
            <div class="form-section">
                <h2 class="section-title"><i class="fas fa-info-circle"></i> Información de Su Empresa</h2>
                <p class="text-muted mb-4">Por favor ingrese los datos principales de su empresa o negocio</p>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="{{ proveedor_form.fecha_diligenciamiento.id_for_label }}" class="form-label required-field">
                            {{ proveedor_form.fecha_diligenciamiento.label }}
                        </label>
                        {{ proveedor_form.fecha_diligenciamiento }}
                        {% if proveedor_form.fecha_diligenciamiento.errors %}
                            <div class="text-danger">{{ proveedor_form.fecha_diligenciamiento.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-8 mb-3">
                        <label for="{{ proveedor_form.nombre_razon_social.id_for_label }}" class="form-label required-field">
                            {{ proveedor_form.nombre_razon_social.label }}
                        </label>
                        {{ proveedor_form.nombre_razon_social }}
                        {% if proveedor_form.nombre_razon_social.errors %}
                            <div class="text-danger">{{ proveedor_form.nombre_razon_social.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="{{ proveedor_form.naturaleza_juridica.id_for_label }}" class="form-label required-field">
                            {{ proveedor_form.naturaleza_juridica.label }}
                        </label>
                        {{ proveedor_form.naturaleza_juridica }}
                        {% if proveedor_form.naturaleza_juridica.errors %}
                            <div class="text-danger">{{ proveedor_form.naturaleza_juridica.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-4 mb-3">
                        <label for="{{ proveedor_form.tipo_identificacion.id_for_label }}" class="form-label required-field">
                            {{ proveedor_form.tipo_identificacion.label }}
                        </label>
                        {{ proveedor_form.tipo_identificacion }}
                        {% if proveedor_form.tipo_identificacion.errors %}
                            <div class="text-danger">{{ proveedor_form.tipo_identificacion.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-4 mb-3">
                        <label for="{{ proveedor_form.numero_identificacion.id_for_label }}" class="form-label required-field">
                            {{ proveedor_form.numero_identificacion.label }}
                        </label>
                        {{ proveedor_form.numero_identificacion }}
                        {% if proveedor_form.numero_identificacion.errors %}
                            <div class="text-danger">{{ proveedor_form.numero_identificacion.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label for="{{ proveedor_form.direccion.id_for_label }}" class="form-label required-field">
                            {{ proveedor_form.direccion.label }}
                        </label>
                        {{ proveedor_form.direccion }}
                        {% if proveedor_form.direccion.errors %}
                            <div class="text-danger">{{ proveedor_form.direccion.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="{{ proveedor_form.telefono.id_for_label }}" class="form-label required-field">
                            {{ proveedor_form.telefono.label }}
                        </label>
                        {{ proveedor_form.telefono }}
                        {% if proveedor_form.telefono.errors %}
                            <div class="text-danger">{{ proveedor_form.telefono.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-4 mb-3">
                        <label for="{{ proveedor_form.celular.id_for_label }}" class="form-label required-field">
                            {{ proveedor_form.celular.label }}
                        </label>
                        {{ proveedor_form.celular }}
                        {% if proveedor_form.celular.errors %}
                            <div class="text-danger">{{ proveedor_form.celular.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-4 mb-3">
                        <label for="{{ proveedor_form.pais.id_for_label }}" class="form-label required-field">
                            {{ proveedor_form.pais.label }}
                        </label>
                        {{ proveedor_form.pais }}
                        {% if proveedor_form.pais.errors %}
                            <div class="text-danger">{{ proveedor_form.pais.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ proveedor_form.departamento.id_for_label }}" class="form-label required-field">
                            {{ proveedor_form.departamento.label }}
                        </label>
                        {{ proveedor_form.departamento }}
                        {% if proveedor_form.departamento.errors %}
                            <div class="text-danger">{{ proveedor_form.departamento.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="{{ proveedor_form.ciudad.id_for_label }}" class="form-label required-field">
                            {{ proveedor_form.ciudad.label }}
                        </label>
                        {{ proveedor_form.ciudad }}
                        {% if proveedor_form.ciudad.errors %}
                            <div class="text-danger">{{ proveedor_form.ciudad.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- SECCIÓN 2: OTROS CONTACTOS -->
            <div class="form-section">
                <h2 class="section-title"><i class="fas fa-address-book"></i> Personas de Contacto</h2>
                <p class="text-muted mb-3">
                    <i class="fas fa-lightbulb"></i>
                    <strong>Opcional:</strong> Puede agregar contactos adicionales de su empresa (gerente, contador, etc.)
                    para que podamos comunicarnos de manera más eficiente.
                </p>

                <div id="contactos-container">
                    {{ contacto_formset.management_form }}
                    {% for form in contacto_formset %}
                        <div class="contact-group mb-4 p-3 border rounded">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">Contacto {{ forloop.counter }}</h5>
                                <button type="button" class="btn btn-sm btn-outline-danger remove-contact">Eliminar</button>
                            </div>
                            {{ form.id }}
                            {% if form.DELETE %}{{ form.DELETE }}{% endif %}
                            <div class="row">
                                <div class="col-md-6 mb-3">{{ form.nombre_apellidos.label_tag }}{{ form.nombre_apellidos }}</div>
                                <div class="col-md-6 mb-3">{{ form.cargo.label_tag }}{{ form.cargo }}</div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">{{ form.direccion.label_tag }}{{ form.direccion }}</div>
                                <div class="col-md-6 mb-3">{{ form.ciudad.label_tag }}{{ form.ciudad }}</div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">{{ form.correo_electronico.label_tag }}{{ form.correo_electronico }}</div>
                                <div class="col-md-4 mb-3">{{ form.telefono.label_tag }}{{ form.telefono }}</div>
                                <div class="col-md-4 mb-3">{{ form.celular.label_tag }}{{ form.celular }}</div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <div class="text-end mt-2">
                    <button type="button" class="btn btn-sm btn-outline-primary" id="add-contact-btn">
                        <i class="fas fa-plus"></i> Agregar Otro Contacto
                    </button>
                </div>

                <div id="empty-contact-form" style="display: none;">
                    <div class="contact-group mb-4 p-3 border rounded">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Nuevo Contacto</h5>
                            <button type="button" class="btn btn-sm btn-outline-danger remove-contact">Eliminar</button>
                        </div>
                        {{ contacto_formset.empty_form.id }}
                        {% if contacto_formset.empty_form.DELETE %}{{ contacto_formset.empty_form.DELETE }}{% endif %}
                        <div class="row">
                            <div class="col-md-6 mb-3">{{ contacto_formset.empty_form.nombre_apellidos.label_tag }}{{ contacto_formset.empty_form.nombre_apellidos }}</div>
                            <div class="col-md-6 mb-3">{{ contacto_formset.empty_form.cargo.label_tag }}{{ contacto_formset.empty_form.cargo }}</div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">{{ contacto_formset.empty_form.direccion.label_tag }}{{ contacto_formset.empty_form.direccion }}</div>
                            <div class="col-md-6 mb-3">{{ contacto_formset.empty_form.ciudad.label_tag }}{{ contacto_formset.empty_form.ciudad }}</div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">{{ contacto_formset.empty_form.correo_electronico.label_tag }}{{ contacto_formset.empty_form.correo_electronico }}</div>
                            <div class="col-md-4 mb-3">{{ contacto_formset.empty_form.telefono.label_tag }}{{ contacto_formset.empty_form.telefono }}</div>
                            <div class="col-md-4 mb-3">{{ contacto_formset.empty_form.celular.label_tag }}{{ contacto_formset.empty_form.celular }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECCIÓN 3: IMPUESTOS (NUEVA TABLA) -->
            <div class="form-section">
                <h2 class="section-title"><i class="fas fa-receipt"></i> Información Tributaria</h2>
                <p class="text-muted mb-4">
                    <i class="fas fa-info-circle"></i>
                    Por favor indique qué retenciones aplican a su empresa y los porcentajes o tarifas correspondientes.
                </p>

                <table class="table table-bordered table-hover">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 50%;">Tipo Retención</th>
                            <th style="width: 15%; text-align: center;">Aplica</th>
                            <th style="width: 35%; text-align: center;">Porcentaje (%) / Tarifa (‰)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Fila Compras -->
                        <tr>
                            <td>Retención en la Fuente por Compras</td>
                            <td style="text-align: center;">{{ impuestos_form.aplica_COMPRAS }}</td>
                            <td>
                                <div class="input-group">
                                    {{ impuestos_form.porcentaje_COMPRAS }}
                                    <span class="input-group-text">%</span>
                                </div>
                            </td>
                        </tr>
                        <!-- Fila Servicios -->
                        <tr>
                            <td>Retención en la Fuente por Servicios</td>
                            <td style="text-align: center;">{{ impuestos_form.aplica_SERVICIOS }}</td>
                            <td>
                                <div class="input-group">
                                    {{ impuestos_form.porcentaje_SERVICIOS }}
                                    <span class="input-group-text">%</span>
                                </div>
                            </td>
                        </tr>
                        <!-- Fila Transporte -->
                        <tr>
                            <td>Retención en la Fuente por Transporte</td>
                            <td style="text-align: center;">{{ impuestos_form.aplica_TRANSPORTE }}</td>
                            <td>
                                <div class="input-group">
                                    {{ impuestos_form.porcentaje_TRANSPORTE }}
                                    <span class="input-group-text">%</span>
                                </div>
                            </td>
                        </tr>
                        <!-- Fila ICA -->
                        <tr>
                            <td>Código Actividad Económica (CIIU)</td>
                            <td style="text-align: center;">{{ impuestos_form.aplica_ICA }}</td>
                            <td>
                                <div class="input-group">
                                    {{ impuestos_form.tarifa_ICA }}
                                    <span class="input-group-text">‰</span>
                                </div>
                            </td>
                        </tr>
                        <!-- Fila Otro -->
                        <tr>
                            <td>Retención en la Fuente por Otro Concepto</td>
                            <td style="text-align: center;">{{ impuestos_form.aplica_OTRO }}</td>
                            <td>
                                <div class="input-group">
                                    {{ impuestos_form.porcentaje_OTRO }}
                                    <span class="input-group-text">%</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <!-- Campos Condicionales -->
                <div id="conditional-ICA" class="conditional-fields" style="display:none;">
                    <h5 class="mt-4">Detalles de Actividad Económica (CIIU)</h5>
                    <div class="row p-3 border rounded">
                         <div class="col-md-6 mb-3">
                            <label class="form-label" for="{{ impuestos_form.codigo_ciiu_ICA.id_for_label }}">{{ impuestos_form.codigo_ciiu_ICA.label }}</label>
                            {{ impuestos_form.codigo_ciiu_ICA }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label" for="{{ impuestos_form.municipio_ICA.id_for_label }}">{{ impuestos_form.municipio_ICA.label }}</label>
                            {{ impuestos_form.municipio_ICA }}
                        </div>
                    </div>
                </div>
                <div id="conditional-OTRO" class="conditional-fields" style="display:none;">
                    <h5 class="mt-4">Detalles de Otro Concepto</h5>
                    <div class="row p-3 border rounded">
                        <div class="col-md-12 mb-3">
                             <label class="form-label" for="{{ impuestos_form.otro_concepto_OTRO.id_for_label }}">{{ impuestos_form.otro_concepto_OTRO.label }}</label>
                            {{ impuestos_form.otro_concepto_OTRO }}
                        </div>
                    </div>
                </div>


                <!-- Sección de Exención -->
                <div class="mt-4 p-3 border rounded">
                    <h5 class="mb-3">Exención de Retención</h5>
                    <p class="text-muted">Si es exento de alguna retención, indique los detalles a continuación.</p>
                     <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label" for="{{ impuestos_form.resolucion_exento_numero.id_for_label }}">{{ impuestos_form.resolucion_exento_numero.label }}</label>
                           {{ impuestos_form.resolucion_exento_numero }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label" for="{{ impuestos_form.resolucion_exento_fecha.id_for_label }}">{{ impuestos_form.resolucion_exento_fecha.label }}</label>
                            {{ impuestos_form.resolucion_exento_fecha }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECCIÓN 4: CONDICIONES DE PAGO -->
            <div class="form-section">
                 <h2 class="section-title"><i class="fas fa-credit-card"></i> Sus Condiciones de Pago</h2>
                <p class="text-muted mb-4">
                    <i class="fas fa-calendar-alt"></i>
                    Indique cuál es su política de pago preferida (contado, crédito a 30 días, etc.)
                </p>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ proveedor_form.condicion_pago.id_for_label }}" class="form-label required-field">
                            {{ proveedor_form.condicion_pago.label }}
                        </label>
                        {{ proveedor_form.condicion_pago }}
                        {% if proveedor_form.condicion_pago.errors %}
                            <div class="text-danger">{{ proveedor_form.condicion_pago.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="{{ proveedor_form.condicion_pago_otro.id_for_label }}" class="form-label">
                            {{ proveedor_form.condicion_pago_otro.label }}
                        </label>
                        {{ proveedor_form.condicion_pago_otro }}
                        <small class="form-text">Solo si seleccionó "Otro" en la condición de pago</small>
                        {% if proveedor_form.condicion_pago_otro.errors %}
                            <div class="text-danger">{{ proveedor_form.condicion_pago_otro.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- SECCIÓN 5: DOCUMENTOS REQUERIDOS -->
            <div class="form-section">
                <h2 class="section-title"><i class="fas fa-file-upload"></i> Documentos de Su Empresa</h2>
                <p class="text-muted mb-3">
                    <i class="fas fa-upload"></i>
                    Por favor adjunte los siguientes documentos de su empresa.
                    <strong>Formatos aceptados:</strong> PDF, JPG, PNG (Máximo 10MB por archivo)
                </p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Nota:</strong> Estos documentos son necesarios para completar su registro como proveedor.
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ documento_form.fotocopia_rut.id_for_label }}" class="form-label">{{ documento_form.fotocopia_rut.label }}</label>
                        {{ documento_form.fotocopia_rut }}
                        {% if documento_form.fotocopia_rut.errors %}<div class="text-danger">{{ documento_form.fotocopia_rut.errors }}</div>{% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="{{ documento_form.solicitud_vinculacion.id_for_label }}" class="form-label">{{ documento_form.solicitud_vinculacion.label }}</label>
                        {{ documento_form.solicitud_vinculacion }}
                        {% if documento_form.solicitud_vinculacion.errors %}<div class="text-danger">{{ documento_form.solicitud_vinculacion.errors }}</div>{% endif %}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ documento_form.certificado_camara_comercio.id_for_label }}" class="form-label">{{ documento_form.certificado_camara_comercio.label }}</label>
                        {{ documento_form.certificado_camara_comercio }}
                        {% if documento_form.certificado_camara_comercio.errors %}<div class="text-danger">{{ documento_form.certificado_camara_comercio.errors }}</div>{% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="{{ documento_form.certificacion_bancaria.id_for_label }}" class="form-label">{{ documento_form.certificacion_bancaria.label }}</label>
                        {{ documento_form.certificacion_bancaria }}
                        {% if documento_form.certificacion_bancaria.errors %}<div class="text-danger">{{ documento_form.certificacion_bancaria.errors }}</div>{% endif %}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ documento_form.fotocopia_cc_representante.id_for_label }}" class="form-label">{{ documento_form.fotocopia_cc_representante.label }}</label>
                        {{ documento_form.fotocopia_cc_representante }}
                        {% if documento_form.fotocopia_cc_representante.errors %}<div class="text-danger">{{ documento_form.fotocopia_cc_representante.errors }}</div>{% endif %}
                    </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ documento_form.autorizacion_datos.id_for_label }}" class="form-label">{{ documento_form.autorizacion_datos.label }}</label>
                        <div class="signature-wrapper" id="sig-wrapper-auth">
                            <div class="btn-group w-100 mb-2">
                                <button type="button" class="btn btn-secondary active sig-toggle-btn" data-target="draw">Dibujar Firma</button>
                                <button type="button" class="btn btn-secondary sig-toggle-btn" data-target="upload">Subir Archivo</button>
                            </div>
                            <div class="sig-draw-section">
                                <div class="signature-pad-container">
                                    <canvas id="signature-pad-auth" class="signature-pad-canvas"></canvas>
                                </div>
                                <div class="signature-pad-actions">
                                    <button type="button" class="btn btn-sm btn-outline-danger sig-clear-btn">Limpiar</button>
                                </div>
                            </div>
                            <div class="sig-upload-section" style="display: none;">
                                {{ documento_form.autorizacion_datos }}
                            </div>
                            <input type="hidden" name="autorizacion_datos_base64" id="autorizacion_datos_base64">
                        </div>
                        {% if documento_form.autorizacion_datos.errors %}<div class="text-danger">{{ documento_form.autorizacion_datos.errors }}</div>{% endif %}
                    </div>
                </div>
            </div>

            <!-- SECCIÓN 6: FIRMA Y REPRESENTANTE LEGAL -->
            <div class="form-section">
                <h2 class="section-title"><i class="fas fa-signature"></i> Representante Legal</h2>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label for="{{ proveedor_form.datos_representante_legal.id_for_label }}" class="form-label required-field">{{ proveedor_form.datos_representante_legal.label }}</label>
                        {{ proveedor_form.datos_representante_legal }}
                        {% if proveedor_form.datos_representante_legal.errors %}<div class="text-danger">{{ proveedor_form.datos_representante_legal.errors }}</div>{% endif %}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="{{ proveedor_form.firma_representante.id_for_label }}" class="form-label">{{ proveedor_form.firma_representante.label }}</label>
                        <div class="signature-wrapper" id="sig-wrapper-rep">
                            <div class="btn-group w-100 mb-2">
                                <button type="button" class="btn btn-secondary active sig-toggle-btn" data-target="draw">Dibujar Firma</button>
                                <button type="button" class="btn btn-secondary sig-toggle-btn" data-target="upload">Subir Archivo</button>
                            </div>
                            <div class="sig-draw-section">
                                <div class="signature-pad-container">
                                    <canvas id="signature-pad-rep" class="signature-pad-canvas"></canvas>
                                </div>
                                <div class="signature-pad-actions">
                                    <button type="button" class="btn btn-sm btn-outline-danger sig-clear-btn">Limpiar</button>
                                </div>
                            </div>
                            <div class="sig-upload-section" style="display: none;">
                                {{ proveedor_form.firma_representante }}
                            </div>
                            <input type="hidden" name="firma_representante_base64" id="firma_representante_base64">
                        </div>
                        <small class="form-text">Puede dibujar su firma o subir una imagen.</small>
                        {% if proveedor_form.firma_representante.errors %}<div class="text-danger">{{ proveedor_form.firma_representante.errors }}</div>{% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="{{ proveedor_form.sello.id_for_label }}" class="form-label">{{ proveedor_form.sello.label }}</label>
                        {{ proveedor_form.sello }}
                        <small class="form-text">Formato de imagen (PNG, JPG)</small>
                        {% if proveedor_form.sello.errors %}<div class="text-danger">{{ proveedor_form.sello.errors }}</div>{% endif %}
                    </div>
                </div>
            </div>

            <!-- BOTONES DE ACCIÓN -->
            <div class="text-center mt-5">
                <button type="submit" class="btn btn-primary btn-lg px-5" id="submit-btn">Completar Registro</button>
                <button type="reset" class="btn btn-secondary btn-lg ms-3 px-5">Limpiar Formulario</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="{% static 'js/signature_pad.min.js' %}"></script>
<script>
$(document).ready(function() {
    // ... (código de signature pad y campos condicionales) ...

    // ==================================================
    // --- MANEJO DINÁMICO DE FORMSET DE CONTACTOS ---
    // ==================================================
    
    // Agregar un nuevo formulario de contacto
    $('#add-contact-btn').on('click', function() {
        const totalFormsInput = $('#id_contactos-TOTAL_FORMS');
        const formIdx = parseInt(totalFormsInput.val());
        const emptyFormHtml = $('#empty-contact-form').html().replace(/__prefix__/g, formIdx);
        
        $('#contactos-container').append(emptyFormHtml);
        totalFormsInput.val(formIdx + 1);
    });

    // Eliminar formularios de contacto (ya sea uno existente o uno recién agregado)
    $('#contactos-container').on('click', '.remove-contact', function() {
        var contactGroup = $(this).closest('.contact-group');
        var deleteCheckbox = contactGroup.find('input[name$="-DELETE"]');
        
        if (deleteCheckbox.length) {
            // Si es un formulario existente, marcarlo para eliminación
            deleteCheckbox.prop('checked', true);
            contactGroup.slideUp();
        } else {
            // Si es un formulario nuevo (agregado dinámicamente), simplemente eliminarlo del DOM
            contactGroup.remove();
            // No es necesario decrementar TOTAL_FORMS, Django lo maneja
        }
    });

    // ... (resto del código JS) ...
});
</script>
{% endblock %}
